<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Starforger Clicker ‚ú®</title>
  <style>
    :root{
      --bg:#070a10; 
      --panel:#0f1621;
      --panel2:#0b111b;
      --border:#1d2a3a;
      --text:#e8eef8;
      --muted:#a7b6cc;
      --good:#5dd39e;
      --bad:#ff6b6b;
      --gold:#ffcc66;
      --purple:#b388ff;
      --cyan:#7bdff2;
      --shadow: rgba(0,0,0,.35);
      --btn:#121e2c;
      --btnBorder:#284056;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }
    html{ height: 100%; }
    body{
      margin:0;
      min-height: 100vh;
      min-height: 100%;
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(123,223,242,.08), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(179,136,255,.08), transparent 55%),
        radial-gradient(900px 650px at 50% 90%, rgba(255,204,102,.05), transparent 65%),
        var(--bg);
      overflow-x:hidden;
    }
    .wrap{
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: none;
      min-height: 100vh;
      min-height: 100%;
      padding: 16px 20px 220px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    h1{ margin:0; font-size: 22px; letter-spacing:.3px; }
    .subtitle{ margin:0; color: var(--muted); font-size: 13px; }
    .topRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      background: rgba(15,22,33,.8);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 8px 22px var(--shadow);
      backdrop-filter: blur(6px);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .pill b{ color: var(--text); }
    button{
      background: var(--btn);
      border: 1px solid var(--btnBorder);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
    }
    button:hover{ filter: brightness(1.08); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .ghost{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 14px;
      flex: 1;
      min-height: 0;
    }
    @media(max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .grid .card{
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .grid .card > .cardTitle,
    .grid .card > .tabs{ flex-shrink: 0; }
    .grid .card > #tab_machines,
    .grid .card > #tab_tools,
    .grid .card > #tab_achievements,
    .grid .card > #tab_log{
      flex: 1 1 0;
      min-height: 0;
      overflow: hidden;
    }
    .grid .card > #tab_machines,
    .grid .card > #tab_tools{ overflow: auto; }
    .grid .card > #tab_achievements{ overflow: auto; }
    .grid .card > #tab_log{
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .grid .card > #tab_log .log{ flex: 1; min-height: 0; overflow: auto; }
    .grid .card:first-child .orbWrap{ flex: 1; min-height: 0; }
    .card{
      background: rgba(15,22,33,.85);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 18px 60px var(--shadow);
      backdrop-filter: blur(8px);
      padding: 14px;
    }
    .cardTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .cardTitle h2{ margin:0; font-size: 16px; }
    .small{ font-size:12px; color: var(--muted); }
    .bigNumber{
      font-variant-numeric: tabular-nums;
      font-size: 34px;
      font-weight: 900;
      letter-spacing: .3px;
      margin: 10px 0 6px;
    }
    .rate{
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 12px;
    }

    /* Orb */
    .orbWrap{
      display:flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .orbArea{
      position: relative;
      width: 320px;
      height: 320px;
      margin: 4px auto 0;
      flex: 0 0 auto;
    }
    @media(max-width: 520px){
      .orbArea{ width: 280px; height: 280px; }
    }
    .orb{
      width: 100%;
      height: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(circle at 30% 30%, rgba(123,223,242,.38), transparent 45%),
        radial-gradient(circle at 65% 40%, rgba(179,136,255,.34), transparent 48%),
        radial-gradient(circle at 45% 70%, rgba(255,204,102,.18), transparent 52%),
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.08), rgba(0,0,0,.35) 60%),
        #0a101a;
      box-shadow:
        inset 0 0 30px rgba(0,0,0,.45),
        0 25px 60px rgba(0,0,0,.6);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: translateZ(0);
      transition: transform .06s ease;
      position: relative;
      overflow:hidden;
      touch-action: manipulation;
    }
    .orb:active{ transform: scale(.985); }
    .orbHeatOverlay{
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,120,50,.5), rgba(200,60,20,.35) 40%, transparent 65%);
      pointer-events: none;
      opacity: 0;
      transition: opacity .12s ease;
    }
    .orb.orbHolding .orbGlow{
      transition: filter .15s ease, opacity .15s ease;
    }
    .orbExplode{
      animation: orbExplode .5s ease-out forwards;
      pointer-events: none;
    }
    @keyframes orbExplode{
      0% { filter: brightness(1.5); box-shadow: 0 0 0 0 rgba(255,80,30,.8), 0 25px 60px rgba(0,0,0,.6); }
      30% { filter: brightness(2.5); box-shadow: 0 0 60px 20px rgba(255,100,40,.9), 0 25px 60px rgba(0,0,0,.6); }
      100% { filter: brightness(0.7); box-shadow: 0 0 0 0 transparent, 0 25px 60px rgba(0,0,0,.6); }
    }
    .orbGlow{
      position:absolute; inset:-30%;
      background: conic-gradient(from 0deg,
        rgba(123,223,242,.0),
        rgba(123,223,242,.22),
        rgba(179,136,255,.2),
        rgba(255,204,102,.12),
        rgba(123,223,242,.22),
        rgba(123,223,242,.0)
      );
      filter: blur(18px);
      animation: spin 6.5s linear infinite;
      opacity:.85;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .orbCore{
      position: absolute; inset: 14%;
      border-radius: 999px;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.12), rgba(0,0,0,.48) 70%);
      border: 1px solid rgba(255,255,255,.09);
      box-shadow: inset 0 0 26px rgba(0,0,0,.6);
    }
    .orbText{
      position: relative;
      text-align:center;
      z-index: 2;
      padding: 10px;
    }
    .orbText .label{ color: var(--muted); font-size: 12px; }
    .orbText .tap{ font-size: 18px; font-weight: 900; letter-spacing: .2px; }
    .orbText .hint{ color: var(--muted); font-size: 11px; margin-top: 6px; }

    /* Floating numbers */
    .float{
      position:absolute;
      transform: translate(-50%,-50%);
      pointer-events:none;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      text-shadow: 0 8px 30px rgba(0,0,0,.85);
      opacity: 0;
      animation: floatUp .85s ease forwards;
      white-space: nowrap;
    }
    @keyframes floatUp{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.96); }
      20%{ opacity: 1; }
      100%{ opacity:0; transform: translate(-50%,-120%) scale(1.05); }
    }

    /* Tabs */
    .tabs{ display:flex; gap: 8px; flex-wrap:wrap; margin-bottom: 10px; }
    .tabBtn{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(10,16,26,.55);
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      user-select:none;
    }
    .tabBtn.active{
      color: var(--text);
      border-color: rgba(123,223,242,.35);
      box-shadow: 0 0 0 2px rgba(123,223,242,.08) inset;
    }

    /* Lists */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      background: rgba(11,17,27,.75);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      transition: transform .08s ease, border-color .08s ease;
    }
    .item.canBuy{
      border-color: rgba(93,211,158,.35);
      box-shadow: 0 0 0 2px rgba(93,211,158,.08) inset;
    }
    .item.canBuy .name::after{
      content:"  ‚Ä¢ can buy";
      color: rgba(93,211,158,.9);
      font-weight: 900;
      font-size: 11px;
    }
    .item.pulse{
      animation: pulse 1.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100% { transform: translateZ(0) scale(1); }
      50% { transform: translateZ(0) scale(1.015); }
    }
    .item .left{ min-width: 0; }
    .item .name{ font-weight: 900; }
    .item .desc{ color: var(--muted); font-size: 12px; margin-top: 4px; line-height: 1.25; }
    .badge{
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #284056;
      background: rgba(10,16,26,.55);
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .priceRow{ display:flex; gap: 8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;}
    .price{ font-weight: 900; font-variant-numeric: tabular-nums; }
    .owned{ color: var(--good); font-weight: 900; }

    /* Log */
    .log{
      min-height: 200px;
      overflow: auto;
      padding-right: 6px;
      scrollbar-color: #2a4158 #0c121b;
    }
    .entry{
      border: 1px solid var(--border);
      background: rgba(11,17,27,.75);
      border-radius: 12px;
      padding: 10px;
      margin: 8px 0;
    }
    .entry .meta{ font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .entry.good{ border-left: 4px solid var(--good); }
    .entry.bad{ border-left: 4px solid var(--bad); }
    .entry.gold{ border-left: 4px solid var(--gold); }
    .entry.purple{ border-left: 4px solid var(--purple); }

    /* Toast */
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 360px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      z-index: 50;
      pointer-events:none;
    }
    .toast .t{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,22,33,.92);
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      animation: pop .2s ease;
    }
    @keyframes pop{ from{ transform: translateY(8px); opacity:.6 } to{ transform: translateY(0); opacity: 1 } }
    .t .title{ font-weight: 900; }
    .t .msg{ color: var(--muted); font-size: 12px; margin-top: 2px; }

    /* Mini stats */
    .mini{
      display:flex; flex-direction:column; gap: 10px; min-width: 240px;
      flex:1 1 240px;
    }
    .meter{
      background: rgba(11,17,27,.75);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(10,16,26,.7);
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
      margin-top: 8px;
    }
    .fill{
      height:100%;
      width: 0%;
      background: var(--cyan);
      transition: width .15s linear;
    }
    .controls{
      display:flex; gap: 8px; flex-wrap:wrap; margin-top: 10px; align-items:center;
    }
    .eventBanner{
      border: 1px solid rgba(255,204,102,.22);
      background: rgba(255,204,102,.06);
      border-radius: 14px;
      padding: 10px;
      margin-top: 10px;
      display:none;
    }
    .eventBanner b{ color: var(--gold); }

    /* Live starfield */
    .starfield{
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .starfield .star{
      position: absolute;
      width: 2px;
      height: 2px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(255,255,255,.6);
      animation: twinkle 4s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%, 100% { opacity: .25; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.3); }
    }
    .shooting-star{
      position: absolute;
      left: -15%;
      top: -5%;
      width: 120px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.95), transparent);
      border-radius: 2px;
      transform: rotate(-55deg);
      transform-origin: left center;
      opacity: 0;
      box-shadow: 0 0 12px rgba(255,255,255,.5);
    }
    .shooting-star.s1{ animation: shoot 1.1s linear infinite; animation-delay: 0s; }
    .shooting-star.s2{ animation: shoot 1.1s linear infinite; animation-delay: 5.2s; }
    .shooting-star.s3{ animation: shoot 1.1s linear infinite; animation-delay: 10.4s; }
    @keyframes shoot{
      0% { left: -15%; top: -5%; opacity: 0; }
      8% { opacity: 1; }
      92% { opacity: 1; }
      100% { left: 115%; top: 105%; opacity: 0; }
    }

    /* Ship arena */
    .shipArena{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      z-index: 5;
      pointer-events: none;
      overflow: hidden;
    }
    .shipArenaBg{
      position: absolute;
      inset: 0;
      background:
        linear-gradient(180deg, transparent 0%, rgba(10,20,40,.4) 30%, rgba(15,25,50,.85) 70%),
        radial-gradient(ellipse 120% 80% at 50% 100%, rgba(123,223,242,.12), transparent 50%),
        radial-gradient(ellipse 80% 60% at 20% 100%, rgba(179,136,255,.1), transparent 45%),
        radial-gradient(ellipse 80% 60% at 80% 100%, rgba(255,204,102,.08), transparent 45%);
    }
    .shipViewport{
      position: absolute;
      inset: 0;
      overflow: hidden;
    }
    .shipArenaHud{
      position: absolute;
      bottom: 8px;
      left: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }
    .shipHudLabel{ font-weight: 900; color: var(--cyan); }
    .shipHudStat{ opacity: .9; }

    .ship{
      position: absolute;
      left: 50%;
      bottom: 42px;
      width: 48px;
      height: 32px;
      margin-left: -24px;
      transform-origin: center bottom;
      transition: left .08s ease-out, bottom .06s ease-out;
      z-index: 10;
    }
    .shipBody{
      position: absolute;
      left: 8px;
      bottom: 0;
      width: 32px;
      height: 22px;
      background: linear-gradient(180deg, #3a6a8a 0%, #1e3a52 50%, #0f2035 100%);
      border-radius: 4px 4px 12px 12px;
      border: 1px solid rgba(123,223,242,.35);
      box-shadow: 0 0 20px rgba(123,223,242,.2), inset 0 2px 0 rgba(255,255,255,.15);
    }
    .shipNose{
      position: absolute;
      left: 0;
      bottom: 6px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 0 10px 16px;
      border-color: transparent transparent rgba(123,223,242,.6) transparent;
      filter: drop-shadow(0 0 6px rgba(123,223,242,.5));
    }
    .shipEngine{
      position: absolute;
      right: 0;
      bottom: 4px;
      width: 14px;
      height: 14px;
      background: radial-gradient(circle, #7bdff2 0%, #2a8a9e 40%, transparent 70%);
      border-radius: 50%;
      animation: enginePulse 0.4s ease-in-out infinite;
    }
    @keyframes enginePulse{ 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: .7; transform: scale(1.1); } }
    .shipWing{ position: absolute; bottom: 2px; width: 12px; height: 10px; background: linear-gradient(135deg, rgba(179,136,255,.5), rgba(100,60,180,.6)); border-radius: 2px; border: 1px solid rgba(179,136,255,.4); }
    .shipWingL{ left: 2px; transform: skewY(-8deg); }
    .shipWingR{ right: 2px; transform: skewY(8deg); }
    .shipWing[data-part].unlocked{ opacity: 1; }
    .shipWing[data-part]:not(.unlocked){ opacity: 0; pointer-events: none; }
    .shipComboGlow{ position: absolute; left: 50%; bottom: 8px; margin-left: -10px; width: 20px; height: 8px; background: radial-gradient(ellipse, rgba(179,136,255,.4), transparent 70%); border-radius: 50%; animation: enginePulse 0.8s ease-in-out infinite; }
    .shipComboGlow[data-part].unlocked{ opacity: 1; }
    .shipComboGlow[data-part]:not(.unlocked){ opacity: 0; }
    .shipCannon{ position: absolute; left: -4px; bottom: 10px; width: 6px; height: 6px; background: radial-gradient(circle, #ffcc66, #cc8800); border-radius: 50%; box-shadow: 0 0 10px #ffcc66; }
    .shipCannon[data-part].unlocked{ opacity: 1; }
    .shipCannon[data-part]:not(.unlocked){ opacity: 0; }
    .shipPulse{ position: absolute; right: 12px; bottom: 2px; width: 8px; height: 8px; background: rgba(93,211,158,.6); border-radius: 50%; animation: enginePulse 0.6s ease-in-out infinite; }
    .shipPulse[data-part].unlocked{ opacity: 1; }
    .shipPulse[data-part]:not(.unlocked){ opacity: 0; }
    .shipStripe{ position: absolute; left: 12px; bottom: 14px; width: 18px; height: 3px; background: linear-gradient(90deg, transparent, rgba(93,211,158,.7), transparent); border-radius: 2px; }
    .shipStripe[data-part].unlocked{ opacity: 1; }
    .shipStripe[data-part]:not(.unlocked){ opacity: 0; }
    .shipCapacitor{ position: absolute; right: 4px; top: 2px; width: 6px; height: 6px; background: rgba(179,136,255,.8); border-radius: 50%; box-shadow: 0 0 8px rgba(179,136,255,.6); animation: enginePulse 1s ease-in-out infinite; }
    .shipCapacitor[data-part].unlocked{ opacity: 1; }
    .shipCapacitor[data-part]:not(.unlocked){ opacity: 0; }
    .shipWingExtra{ position: absolute; left: 50%; margin-left: -18px; bottom: -4px; width: 36px; height: 6px; background: linear-gradient(90deg, transparent, rgba(93,211,158,.4), transparent); border-radius: 2px; }
    .shipWingExtra[data-part].unlocked{ opacity: 1; }
    .shipWingExtra[data-part]:not(.unlocked){ opacity: 0; }
    .shipDoubleEngine{ position: absolute; right: -2px; bottom: 6px; width: 8px; height: 10px; background: radial-gradient(ellipse, rgba(255,204,102,.6), transparent 70%); border-radius: 50%; animation: enginePulse 0.25s ease-in-out infinite; }
    .shipDoubleEngine[data-part].unlocked{ opacity: 1; }
    .shipDoubleEngine[data-part]:not(.unlocked){ opacity: 0; }
    .shipRadar{ position: absolute; left: 50%; top: -6px; margin-left: -4px; width: 8px; height: 6px; background: linear-gradient(180deg, rgba(123,223,242,.6), transparent); clip-path: polygon(50% 0%, 100% 100%, 0% 100%); }
    .shipRadar[data-part].unlocked{ opacity: 1; }
    .shipRadar[data-part]:not(.unlocked){ opacity: 0; }
    .shipDroneWing{ position: absolute; left: -6px; bottom: 12px; width: 8px; height: 6px; background: rgba(123,223,242,.4); border-radius: 2px; }
    .shipDroneWing[data-part].unlocked{ opacity: 1; }
    .shipDroneWing[data-part]:not(.unlocked){ opacity: 0; }
    .shipMiningBeam{ position: absolute; left: -8px; bottom: 8px; width: 4px; height: 8px; background: linear-gradient(90deg, #ffcc66, transparent); border-radius: 2px; box-shadow: 0 0 8px #ffcc66; animation: enginePulse 0.3s ease-in-out infinite; }
    .shipMiningBeam[data-part].unlocked{ opacity: 1; }
    .shipMiningBeam[data-part]:not(.unlocked){ opacity: 0; }
    .shipPlates{ position: absolute; inset: -2px; border: 2px solid rgba(255,204,102,.25); border-radius: 6px 6px 14px 14px; pointer-events: none; }
    .shipPlates[data-part].unlocked{ opacity: 1; }
    .shipPlates[data-part]:not(.unlocked){ opacity: 0; }
    .shipDish{ position: absolute; left: 50%; top: -12px; margin-left: -6px; width: 12px; height: 8px; background: radial-gradient(ellipse, rgba(179,136,255,.5), transparent 70%); border-radius: 50%; }
    .shipDish[data-part].unlocked{ opacity: 1; }
    .shipDish[data-part]:not(.unlocked){ opacity: 0; }
    .shipWarpTrail{ position: absolute; right: -20px; bottom: 8px; width: 24px; height: 4px; background: linear-gradient(90deg, rgba(123,223,242,.5), transparent); border-radius: 2px; filter: blur(2px); animation: enginePulse 0.5s ease-in-out infinite; }
    .shipWarpTrail[data-part].unlocked{ opacity: 1; }
    .shipWarpTrail[data-part]:not(.unlocked){ opacity: 0; }

    .shipProjectiles, .shipObstacles, .shipCollectibles{ position: absolute; inset: 0; pointer-events: none; }
    .proj{ position: absolute; width: 6px; height: 4px; background: linear-gradient(90deg, #7bdff2, transparent); border-radius: 2px; box-shadow: 0 0 8px #7bdff2; }
    .proj.gold{ background: linear-gradient(90deg, #ffcc66, transparent); box-shadow: 0 0 8px #ffcc66; }
    .proj.purple{ background: linear-gradient(90deg, #b388ff, transparent); box-shadow: 0 0 8px #b388ff; }
    .obstacle{ position: absolute; border-radius: 50%; background: linear-gradient(135deg, #2a3544, #1a2230); border: 1px solid #3a4555; box-shadow: inset 0 0 8px rgba(0,0,0,.5); }
    .obstacle.asteroid{ width: 24px; height: 24px; }
    .obstacle.junk{ width: 16px; height: 16px; background: linear-gradient(135deg, #3a3a4a, #2a2a35); }
    .collectible{ position: absolute; width: 12px; height: 12px; background: radial-gradient(circle at 30% 30%, rgba(255,204,102,.9), rgba(200,150,50,.5)); border-radius: 50%; box-shadow: 0 0 12px rgba(255,204,102,.6); animation: collectibleFloat 2s ease-in-out infinite; }
    @keyframes collectibleFloat{ 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    .shipHit{ animation: shipHit 0.3s ease-out; }
    @keyframes shipHit{ 0% { filter: brightness(2); } 50% { filter: brightness(0.5); } 100% { filter: brightness(1); } }
  </style>
</head>

<body>
  <div class="starfield" aria-hidden="true">
    <div class="star" style="left:5%;top:12%;animation-delay:0s"></div>
    <div class="star" style="left:12%;top:8%;animation-delay:.5s"></div>
    <div class="star" style="left:18%;top:22%;animation-delay:1s"></div>
    <div class="star" style="left:25%;top:5%;animation-delay:1.8s"></div>
    <div class="star" style="left:32%;top:18%;animation-delay:.2s"></div>
    <div class="star" style="left:42%;top:12%;animation-delay:2.5s"></div>
    <div class="star" style="left:48%;top:28%;animation-delay:.8s"></div>
    <div class="star" style="left:55%;top:7%;animation-delay:3s"></div>
    <div class="star" style="left:62%;top:24%;animation-delay:1.5s"></div>
    <div class="star" style="left:72%;top:14%;animation-delay:2s"></div>
    <div class="star" style="left:78%;top:6%;animation-delay:.3s"></div>
    <div class="star" style="left:85%;top:20%;animation-delay:2.8s"></div>
    <div class="star" style="left:92%;top:11%;animation-delay:1.2s"></div>
    <div class="star" style="left:8%;top:35%;animation-delay:3.2s"></div>
    <div class="star" style="left:15%;top:42%;animation-delay:.6s"></div>
    <div class="star" style="left:22%;top:38%;animation-delay:2.2s"></div>
    <div class="star" style="left:38%;top:45%;animation-delay:1.8s"></div>
    <div class="star" style="left:52%;top:52%;animation-delay:.4s"></div>
    <div class="star" style="left:65%;top:48%;animation-delay:2.6s"></div>
    <div class="star" style="left:82%;top:55%;animation-delay:1.1s"></div>
    <div class="star" style="left:88%;top:42%;animation-delay:3.5s"></div>
    <div class="star" style="left:3%;top:62%;animation-delay:2.4s"></div>
    <div class="star" style="left:28%;top:68%;animation-delay:.9s"></div>
    <div class="star" style="left:45%;top:72%;animation-delay:3.8s"></div>
    <div class="star" style="left:58%;top:65%;animation-delay:1.6s"></div>
    <div class="star" style="left:75%;top:70%;animation-delay:2.9s"></div>
    <div class="star" style="left:95%;top:58%;animation-delay:.7s"></div>
    <div class="star" style="left:10%;top:78%;animation-delay:3.3s"></div>
    <div class="star" style="left:35%;top:82%;animation-delay:1.4s"></div>
    <div class="star" style="left:68%;top:88%;animation-delay:2.1s"></div>
    <div class="star" style="left:90%;top:75%;animation-delay:.1s"></div>
    <div class="shooting-star s1"></div>
    <div class="shooting-star s2"></div>
    <div class="shooting-star s3"></div>
  </div>

  <div class="wrap">
    <header>
      <div>
        <h1>Starforger Clicker ‚ú®</h1>
        <p class="subtitle">Click ‚Üí buy Machines for DPS ‚Üí buy Tools for multipliers ‚Üí reboot reality.</p>
      </div>
      <div class="topRow">
        <div class="pill">‚ú® Stardust: <b id="dustTxt">0</b></div>
        <div class="pill">‚ö° per sec: <b id="dpsTxt">0</b></div>
        <div class="pill">üëÜ per click: <b id="dpcTxt">1</b></div>
        <button id="saveBtn" class="ghost">Save</button>
        <button id="loadBtn" class="ghost">Load</button>
        <button id="resetBtn" class="ghost">Reset</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="cardTitle">
          <h2>Forge</h2>
          <div class="small">Hold-click works. Starburst at 100% Overcharge. Hold too long and the orb overheats‚Äîyou lose half your Stardust!</div>
        </div>

        <div class="bigNumber" id="bigDust">0 Stardust</div>
        <div class="rate" id="rateTxt">0 per second ‚Ä¢ 1 per click</div>

        <div class="orbWrap">
          <div class="mini">
            <div class="meter">
              <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
                <div><b>Overcharge</b> <span class="small">(builds as you click)</span></div>
                <span class="badge" id="overTxt">0%</span>
              </div>
              <div class="bar"><div class="fill" id="overFill"></div></div>
              <div class="small" style="margin-top:8px;">At 100%, your next click triggers a <b>Starburst</b> bonus.</div>
            </div>

            <div class="meter">
              <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
                <div><b>Reboot Shards</b> <span class="small">(prestige-lite)</span></div>
                <span class="badge"><span id="shardsTxt">0</span> shards</span>
              </div>
              <div class="small" style="margin-top:8px;">
                Reboot resets your run but gives permanent bonuses.
              </div>
              <div class="controls">
                <button id="rebootBtn" class="ghost">Reboot (Prestige)</button>
              </div>
            </div>

            <div class="meter eventBanner" id="eventBanner">
              <div><b>Cosmic Event:</b> <span id="eventTxt"></span></div>
              <div class="small" id="eventSub"></div>
            </div>
          </div>

          <div class="orbArea">
            <div class="orb" id="orb">
              <div class="orbGlow"></div>
              <div class="orbHeatOverlay" id="orbHeatOverlay"></div>
              <div class="orbCore"></div>
              <div class="orbText">
                <div class="label">Click to forge</div>
                <div class="tap">STARDUST</div>
                <div class="hint">Overcharge ‚ûú Starburst ‚Ä¢ Hold too long ‚ûú overheat!</div>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button id="boostBtn">Activate Starboost (30s)</button>
          <span class="pill">‚≠ê Starboost: <b id="boostTxt">ready</b></span>
          <span class="pill">üèÜ Achievements: <b id="achCountTxt">0</b></span>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="cardTitle">
          <h2>Workshop</h2>
          <div class="small">Machines = DPS ‚Ä¢ Tools = buffs ‚Ä¢ Shop never re-breaks.</div>
        </div>

        <div class="tabs">
          <!-- ‚úÖ Machines first, Tools second -->
          <button class="tabBtn active" data-tab="machines">Machines</button>
          <button class="tabBtn" data-tab="tools">Tools</button>
          <button class="tabBtn" data-tab="achievements">Achievements</button>
          <button class="tabBtn" data-tab="log">Log</button>
        </div>

        <div id="tab_machines" class="list"></div>
        <div id="tab_tools" class="list" style="display:none;"></div>

        <div id="tab_achievements" style="display:none;">
          <div class="small">Achievements give small permanent bonuses for this run.</div>
          <div id="achList" class="list" style="margin-top:10px;"></div>
        </div>

        <div id="tab_log" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div class="small">A record of your cosmic mistakes.</div>
            <button id="clearLogBtn" class="ghost">Clear</button>
          </div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ship arena: automated mini-game at bottom -->
  <div class="shipArena" id="shipArena">
    <div class="shipArenaBg"></div>
    <div class="shipViewport" id="shipViewport">
      <div class="ship" id="ship">
        <div class="shipBody"></div>
        <div class="shipNose"></div>
        <div class="shipEngine"></div>
        <div class="shipWing shipWingL" data-part="gloves"></div>
        <div class="shipWing shipWingR" data-part="gloves"></div>
        <div class="shipComboGlow" data-part="tapRhythm"></div>
        <div class="shipCannon" data-part="lens"></div>
        <div class="shipPulse" data-part="autopulse"></div>
        <div class="shipStripe" data-part="efficiency"></div>
        <div class="shipCapacitor" data-part="boostCool"></div>
        <div class="shipWingExtra" data-part="union"></div>
        <div class="shipDoubleEngine" data-part="compressor"></div>
        <div class="shipRadar" data-part="blueprints"></div>
        <div class="shipDroneWing" data-part="drone"></div>
        <div class="shipMiningBeam" data-part="mine"></div>
        <div class="shipPlates" data-part="foundry"></div>
        <div class="shipDish" data-part="observatory"></div>
        <div class="shipWarpTrail" data-part="rift"></div>
      </div>
      <div class="shipProjectiles" id="shipProjectiles"></div>
      <div class="shipObstacles" id="shipObstacles"></div>
      <div class="shipCollectibles" id="shipCollectibles"></div>
    </div>
    <div class="shipArenaHud">
      <span class="shipHudLabel">üõ∏ Scout</span>
      <span class="shipHudStat" id="shipHudSpeed">Speed: 1√ó</span>
      <span class="shipHudStat" id="shipHudParts">Parts: 0</span>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const now = () => Date.now();
  const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const fmt = (n) => {
    if (!isFinite(n)) return "‚àû";
    if (n < 1000) return Math.floor(n).toString();
    const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No"];
    let u = -1, x = n;
    while (x >= 1000 && u < units.length-1) { x /= 1000; u++; }
    return (x >= 100 ? x.toFixed(0) : x >= 10 ? x.toFixed(1) : x.toFixed(2)) + units[u];
  };

  // ---------- Toast + Log ----------
  const logEntries = [];
  function toast(title, msg){
    const t = document.createElement("div");
    t.className = "t";
    t.innerHTML = `<div class="title">${title}</div><div class="msg">${msg}</div>`;
    $("toast").appendChild(t);
    setTimeout(() => { t.style.opacity = "0"; t.style.transform = "translateY(8px)"; }, 2200);
    setTimeout(() => t.remove(), 2600);
  }
  function addLog(kind, meta, text){
    logEntries.unshift({ kind, meta, text, ts: new Date().toLocaleTimeString() });
    if (logEntries.length > 140) logEntries.pop();
    renderLog();
  }
  function renderLog(){
    const log = $("log");
    if (!log) return;
    log.innerHTML = "";
    for (const e of logEntries){
      const div = document.createElement("div");
      div.className = `entry ${e.kind}`;
      div.innerHTML = `<div class="meta">${e.ts} ‚Ä¢ ${e.meta}</div><div>${e.text}</div>`;
      log.appendChild(div);
    }
  }

  // ---------- Game State ----------
  const BASE = {
    dust: 0,
    totalDust: 0,
    dustPerClick: 1,
    overcharge: 0,

    shards: 0,

    starboostReadyAt: 0,
    starboostUntil: 0,

    clickCombo: 0,
    lastClickAt: 0,

    toolsOwned: {},      // renamed from upgradesOwned
    machinesOwned: {},   // renamed from buildingsOwned

    achUnlocked: {},
    achBonusMult: 1.0,

    cosmicEvent: null, // {name, until, mult, sub}
  };

  let S = structuredClone(BASE);

  // ---------- Content ----------
  // Tools = click buffs / multipliers
  const tools = [
    { id:"gloves", name:"Void-Touched Gloves", kind:"click", cost: 15,
      desc:"+1 per click.",
      apply(){ S.dustPerClick += 1; }
    },
    { id:"tapRhythm", name:"Rhythm of the Nebula", kind:"click", cost: 85,
      desc:"Click combo increases per-click (up to +30%).",
      apply(){ /* handled in click calc */ }
    },
    { id:"lens", name:"Starlens Focus", kind:"burst", cost: 180,
      desc:"Starbursts are 25% stronger.",
      apply(){ /* handled in starburst */ }
    },
    { id:"autopulse", name:"Pocket Pulsar", kind:"dps", cost: 90,
      desc:"+0.5/sec passive (tiny but helpful).",
      apply(){ /* handled in baseDps */ }
    },
    { id:"efficiency", name:"Quantum Efficiency", kind:"mult", cost: 220,
      desc:"All production +10%.",
      apply(){ S.achBonusMult *= 1.10; }
    },
    { id:"boostCool", name:"Starboost Capacitor", kind:"boost", cost: 320,
      desc:"Starboost cooldown -25%.",
      apply(){ /* handled in cooldown */ }
    },
    { id:"union", name:"Galactic Workers Union", kind:"machine", cost: 600,
      desc:"Machines produce +15%. (they demanded snacks)",
      apply(){ /* handled in machine mult */ }
    },
    { id:"compressor", name:"Stardust Compressor", kind:"click", cost: 520,
      desc:"Per-click +25%.",
      apply(){ /* handled in click calc */ }
    },
    { id:"blueprints", name:"Astral Blueprints", kind:"econ", cost: 900,
      desc:"Machine cost growth reduced slightly.",
      apply(){ /* handled in price calc */ }
    },
  ];

  // Machines = passive producers
  const machines = [
    { id:"drone", name:"Spark Drone", baseCost: 25, baseDps: 0.2,
      desc:"Tiny worker drone. Reliable. Mildly judgmental."
    },
    { id:"mine", name:"Comet Mine", baseCost: 120, baseDps: 1.2,
      desc:"Extracts stardust from passing comets. Probably legal."
    },
    { id:"foundry", name:"Nebula Foundry", baseCost: 650, baseDps: 7.5,
      desc:"Industrial-scale cosmic forging."
    },
    { id:"observatory", name:"Chrono Observatory", baseCost: 3200, baseDps: 42,
      desc:"Watches time pass. Time gets nervous."
    },
    { id:"rift", name:"Rift Engine", baseCost: 18000, baseDps: 250,
      desc:"Pulls stardust from 'elsewhere'. 'Elsewhere' complains."
    },
  ];

  const achievements = [
    { id:"firstClick", name:"First Spark", desc:"Make your first Stardust.", bonus: 1.02, check: () => S.totalDust >= 1 },
    { id:"hundred", name:"A Small Pile", desc:"Reach 100 total Stardust.", bonus: 1.03, check: () => S.totalDust >= 100 },
    { id:"tenK", name:"Dust Tycoon", desc:"Reach 10,000 total Stardust.", bonus: 1.05, check: () => S.totalDust >= 10000 },
    { id:"combo10", name:"Click Gremlin", desc:"Get a 10-click combo.", bonus: 1.03, check: () => S.clickCombo >= 10 },
    { id:"m5", name:"Supervisor", desc:"Own 5 machines total.", bonus: 1.04, check: () => totalMachines() >= 5 },
    { id:"m25", name:"Middle Management", desc:"Own 25 machines total.", bonus: 1.06, check: () => totalMachines() >= 25 },
    { id:"burst10", name:"Starburst Enjoyer", desc:"Trigger 10 Starbursts.", bonus: 1.04, check: () => (S.achUnlocked._bursts || 0) >= 10 },
    { id:"event", name:"Touched by the Cosmos", desc:"Experience a Cosmic Event.", bonus: 1.03, check: () => !!S.achUnlocked._eventSeen },
  ];

  function hasTool(id){ return !!S.toolsOwned[id]; }
  function totalMachines(){
    return Object.values(S.machinesOwned).reduce((a,b) => a + (b||0), 0);
  }

  // ---------- Economy ----------
  function machineCost(m){
    const owned = S.machinesOwned[m.id] || 0;
    const growth = hasTool("blueprints") ? 1.135 : 1.15;
    return Math.floor(m.baseCost * Math.pow(growth, owned));
  }

  function shardMultiplier(){
    return 1 + 0.06 * Math.pow(S.shards, 0.85);
  }

  function currentMult(){
    let mult = 1.0;
    mult *= S.achBonusMult;
    mult *= shardMultiplier();
    if (now() < S.starboostUntil) mult *= 2.0;
    if (S.cosmicEvent && now() < S.cosmicEvent.until) mult *= S.cosmicEvent.mult;
    return mult;
  }

  function baseMachineDps(){
    const machineMult = hasTool("union") ? 1.15 : 1.0;
    let dps = 0;
    for (const m of machines){
      const owned = S.machinesOwned[m.id] || 0;
      dps += owned * m.baseDps * machineMult;
    }
    if (hasTool("autopulse")) dps += 0.5;
    return dps;
  }

  function clickValue(){
    let v = S.dustPerClick;

    if (hasTool("tapRhythm")){
      const bonus = clamp(S.clickCombo * 0.02, 0, 0.30);
      v *= (1 + bonus);
    }
    if (hasTool("compressor")){
      v *= 1.25;
    }

    v *= currentMult();
    return v;
  }

  function starburstValue(){
    let base = (baseMachineDps() * 3) + (S.dustPerClick * 18);
    if (hasTool("lens")) base *= 1.25;
    base *= currentMult();
    return Math.max(5, base);
  }

  // ---------- UI refs ----------
  const ui = {
    dustTxt: $("dustTxt"),
    bigDust: $("bigDust"),
    dpsTxt: $("dpsTxt"),
    dpcTxt: $("dpcTxt"),
    rateTxt: $("rateTxt"),
    overTxt: $("overTxt"),
    overFill: $("overFill"),
    shardsTxt: $("shardsTxt"),
    boostTxt: $("boostTxt"),
    achCountTxt: $("achCountTxt"),
    eventBanner: $("eventBanner"),
    eventTxt: $("eventTxt"),
    eventSub: $("eventSub"),
    tabMachines: $("tab_machines"),
    tabTools: $("tab_tools"),
    achList: $("achList"),
  };

  // ---------- Shop rendering (IMPORTANT FIX) ----------
  // We build the DOM ONCE and only update labels/affordability afterwards.
  const dom = {
    machine: new Map(), // id -> { root, price, owned, btn }
    tool: new Map(),    // id -> { root, price, btn, ownedBadge }
  };

  function buildShopOnce(){
    // Machines
    ui.tabMachines.innerHTML = "";
    for (const m of machines){
      const root = document.createElement("div");
      root.className = "item";
      root.innerHTML = `
        <div class="left">
          <div class="name">${m.name} <span class="badge" data-owned>Owned: 0</span></div>
          <div class="desc">${m.desc}<br/><span class="small">Produces <b data-prod>0</b>/sec each (with multipliers).</span></div>
        </div>
        <div class="priceRow">
          <span class="badge">dps ${fmt(m.baseDps)}</span>
          <span class="price" data-price>0</span>
          <button data-buy-machine="${m.id}">Buy</button>
        </div>
      `;
      ui.tabMachines.appendChild(root);

      dom.machine.set(m.id, {
        root,
        owned: root.querySelector("[data-owned]"),
        prod: root.querySelector("[data-prod]"),
        price: root.querySelector("[data-price]"),
        btn: root.querySelector(`button[data-buy-machine="${m.id}"]`)
      });
    }

    // Tools
    ui.tabTools.innerHTML = "";
    for (const t of tools){
      const root = document.createElement("div");
      root.className = "item";
      root.innerHTML = `
        <div class="left">
          <div class="name">${t.name} <span class="badge" data-owned style="display:none;">Owned</span></div>
          <div class="desc">${t.desc}</div>
        </div>
        <div class="priceRow">
          <span class="badge">${t.kind}</span>
          <span class="price" data-price>${fmt(t.cost)}</span>
          <button data-buy-tool="${t.id}">Buy</button>
        </div>
      `;
      ui.tabTools.appendChild(root);

      dom.tool.set(t.id, {
        root,
        owned: root.querySelector("[data-owned]"),
        price: root.querySelector("[data-price]"),
        btn: root.querySelector(`button[data-buy-tool="${t.id}"]`)
      });
    }
  }

  function updateShopState(){
    const mult = currentMult();
    const machineMult = hasTool("union") ? 1.15 : 1.0;

    // Machines: update cost, owned, canBuy class, button label
    for (const m of machines){
      const el = dom.machine.get(m.id);
      const owned = S.machinesOwned[m.id] || 0;
      const cost = machineCost(m);
      const canBuy = S.dust >= cost;

      el.owned.textContent = `Owned: ${owned}`;
      el.price.textContent = fmt(cost);
      el.prod.textContent = fmt(m.baseDps * machineMult * mult);

      el.btn.textContent = canBuy ? "Buy" : "Need";
      // do NOT disable (keeps click feel consistent), just style affordably
      el.root.classList.toggle("canBuy", canBuy);
      el.root.classList.toggle("pulse", canBuy);
    }

    // Tools: update owned/canBuy, and disable when owned
    for (const t of tools){
      const el = dom.tool.get(t.id);
      const owned = hasTool(t.id);
      const canBuy = !owned && S.dust >= t.cost;

      el.price.textContent = fmt(t.cost);
      el.btn.textContent = owned ? "Owned" : (canBuy ? "Buy" : "Need");
      el.btn.disabled = owned;

      el.owned.style.display = owned ? "inline-block" : "none";

      el.root.classList.toggle("canBuy", canBuy);
      el.root.classList.toggle("pulse", canBuy);
    }
  }

  // ---------- Tabs ----------
  let activeTab = "machines";
  function setTab(tab){
    activeTab = tab;
    document.querySelectorAll(".tabBtn").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
    $("tab_machines").style.display = tab === "machines" ? "flex" : "none";
    $("tab_tools").style.display = tab === "tools" ? "flex" : "none";
    $("tab_achievements").style.display = tab === "achievements" ? "block" : "none";
    $("tab_log").style.display = tab === "log" ? "flex" : "none";
  }

  // ---------- Achievements ----------
  function unlockAch(a){
    if (S.achUnlocked[a.id]) return;
    S.achUnlocked[a.id] = true;
    S.achBonusMult *= a.bonus;
    toast("Achievement!", a.name);
    addLog("gold", "Achievement", `${a.name} (+${Math.round((a.bonus-1)*100)}% production)`);
  }
  function checkAchievements(){
    for (const a of achievements){
      if (!S.achUnlocked[a.id] && a.check()) unlockAch(a);
    }
  }
  function renderAchievements(){
    ui.achList.innerHTML = "";
    for (const a of achievements){
      const unlocked = !!S.achUnlocked[a.id];
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="left">
          <div class="name">${unlocked ? "üèÜ" : "üîí"} ${a.name} ${unlocked ? '<span class="badge owned">Unlocked</span>' : ''}</div>
          <div class="desc">${a.desc} <span class="small">Bonus: +${Math.round((a.bonus-1)*100)}%</span></div>
        </div>
        <div class="priceRow"><span class="badge">${unlocked ? "done" : "pending"}</span></div>
      `;
      ui.achList.appendChild(row);
    }
  }

  // ---------- Buying ----------
  function buyTool(id){
    const t = tools.find(x => x.id === id);
    if (!t) return false;
    if (hasTool(id)) return false;
    if (S.dust < t.cost) return false;

    S.dust -= t.cost;
    S.toolsOwned[id] = true;
    t.apply();

    addLog("gold", "Tool", `Unlocked: ${t.name}`);
    toast("Tool unlocked", t.name);
    saveDebounced();
    updateShipVisual();
    return true;
  }

  function buyMachine(id){
    const m = machines.find(x => x.id === id);
    if (!m) return false;

    const cost = machineCost(m);
    if (S.dust < cost) return false;

    S.dust -= cost;
    S.machinesOwned[id] = (S.machinesOwned[id] || 0) + 1;

    addLog("good", "Machine", `Built 1√ó ${m.name}.`);
    toast("Built", m.name);
    saveDebounced();
    updateShipVisual();
    return true;
  }

  // ‚úÖ Stable event delegation (works forever, because shop DOM never gets replaced)
  document.addEventListener("click", (e) => {
    const toolBtn = e.target.closest("button[data-buy-tool]");
    if (toolBtn){
      const id = toolBtn.getAttribute("data-buy-tool");
      const ok = buyTool(id);
      if (!ok && !hasTool(id)) toast("Not enough Stardust", "Click more or buy machines first.");
      return;
    }

    const machineBtn = e.target.closest("button[data-buy-machine]");
    if (machineBtn){
      const id = machineBtn.getAttribute("data-buy-machine");
      const ok = buyMachine(id);
      if (!ok) toast("Not enough Stardust", "Wait a moment or click more.");
      return;
    }
  });

  // ---------- Clicking ----------
  function floatText(text, clientX, clientY, color){
    const rect = $("orb").getBoundingClientRect();
    const x = clamp(clientX - rect.left, 10, rect.width - 10);
    const y = clamp(clientY - rect.top, 10, rect.height - 10);

    const el = document.createElement("div");
    el.className = "float";
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.color = color;
    $("orb").parentElement.appendChild(el);
    el.textContent = text;
    setTimeout(() => el.remove(), 900);
  }

  function doClick(clientX, clientY){
    const t = now();
    if (t - S.lastClickAt <= 900) S.clickCombo += 1;
    else S.clickCombo = 1;
    S.lastClickAt = t;

    const amount = clickValue();
    S.dust += amount;
    S.totalDust += amount;

    const ocGain = clamp(2 + Math.min(6, S.clickCombo * 0.3), 2, 7);
    S.overcharge = clamp(S.overcharge + ocGain, 0, 100);

    floatText("+" + fmt(amount), clientX, clientY, "var(--cyan)");

    if (S.overcharge >= 100){
      const burst = starburstValue();
      S.overcharge = 0;
      S.dust += burst;
      S.totalDust += burst;
      S.achUnlocked._bursts = (S.achUnlocked._bursts || 0) + 1;

      floatText("STARBURST +" + fmt(burst), clientX, clientY - 18, "var(--gold)");
      toast("Starburst!", `+${fmt(burst)} Stardust`);
      addLog("gold", "Starburst", `A starburst detonated. (+${fmt(burst)})`);
    }

    checkAchievements();
    saveDebounced();
  }

  const orb = $("orb");
  const orbHeatOverlay = $("orbHeatOverlay");
  const EXPLODE_AFTER_MS = 3500;

  let hold = false;
  let holdTimer = null;
  let holdStartTime = 0;
  let holdAnimationId = null;
  let capturedPointerId = null;

  function applyHeat(heat){
    orb.style.setProperty("--orbHeat", heat);
    orbHeatOverlay.style.opacity = heat;
    const t = (now() - holdStartTime) / 80;
    const shake = 5 * heat;
    orb.style.transform = `translate(${Math.sin(t) * shake}px, ${Math.cos(t * 1.3) * shake}px)`;
    const glow = orb.querySelector(".orbGlow");
    if (glow) glow.style.filter = `blur(18px) hue-rotate(${-60 + heat * 80}deg)`;
  }

  function cancelHold(){
    hold = false;
    if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
    if (holdAnimationId != null) { cancelAnimationFrame(holdAnimationId); holdAnimationId = null; }
    orb.classList.remove("orbHolding", "orbExplode");
    orbHeatOverlay.style.opacity = 0;
    orb.style.transform = "";
    orb.style.removeProperty("--orbHeat");
    const glow = orb.querySelector(".orbGlow");
    if (glow) glow.style.filter = "";
    if (capturedPointerId != null && orb.releasePointerCapture) {
      try { orb.releasePointerCapture(capturedPointerId); } catch(_){}
      capturedPointerId = null;
    }
  }

  function explode(){
    const lost = S.dust * 0.5;
    S.dust *= 0.5;
    addLog("bad", "Overheat!", `The orb exploded. You lost ${fmt(lost)} Stardust.`);
    toast("Overheat!", "The orb exploded! Half your Stardust lost.");
    saveDebounced();
    orb.classList.add("orbExplode");
    orb.classList.remove("orbHolding");
    if (holdAnimationId != null) { cancelAnimationFrame(holdAnimationId); holdAnimationId = null; }
    hold = false;
    if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
    orbHeatOverlay.style.opacity = 0;
    orb.style.transform = "";
    orb.style.removeProperty("--orbHeat");
    const glow = orb.querySelector(".orbGlow");
    if (glow) glow.style.filter = "";
    if (capturedPointerId != null && orb.releasePointerCapture) {
      try { orb.releasePointerCapture(capturedPointerId); } catch(_){}
      capturedPointerId = null;
    }
    setTimeout(() => orb.classList.remove("orbExplode"), 500);
  }

  function heatUpdate(){
    if (!hold) return;
    const duration = now() - holdStartTime;
    const heat = Math.min(1, duration / EXPLODE_AFTER_MS);
    orb.classList.add("orbHolding");
    applyHeat(heat);
    if (heat >= 1){
      explode();
      return;
    }
    holdAnimationId = requestAnimationFrame(heatUpdate);
  }

  function startHold(){
    hold = true;
    holdStartTime = now();
    holdAnimationId = requestAnimationFrame(heatUpdate);
    const repeat = () => {
      if (!hold) return;
      const r = orb.getBoundingClientRect();
      doClick(r.left + r.width/2, r.top + r.height/2);
      holdTimer = setTimeout(repeat, 90);
    };
    holdTimer = setTimeout(repeat, 220);
  }

  orb.addEventListener("pointerdown", (e) => {
    capturedPointerId = e.pointerId;
    orb.setPointerCapture?.(e.pointerId);
    doClick(e.clientX, e.clientY);
    startHold();
  });

  window.addEventListener("pointerup", () => {
    if (hold) cancelHold();
  });

  // ---------- Starboost ----------
  function starboostCooldownMs(){
    const base = 120000;
    return hasTool("boostCool") ? Math.floor(base * 0.75) : base;
  }
  function canStarboost(){
    return now() >= S.starboostReadyAt && now() >= S.starboostUntil;
  }
  function activateStarboost(){
    if (!canStarboost()) return;
    S.starboostUntil = now() + 30000;
    S.starboostReadyAt = now() + starboostCooldownMs();
    toast("Starboost!", "2√ó production for 30s.");
    addLog("purple", "Starboost", "2√ó production for 30 seconds.");
    saveDebounced();
  }
  $("boostBtn").addEventListener("click", activateStarboost);

  // ---------- Cosmic Events ----------
  let cosmicTimer = 0;
  function maybeCosmicEvent(){
    if (S.cosmicEvent && now() < S.cosmicEvent.until) return;
    if (Math.random() > 0.12) return;

    const events = [
      { name:"Meteor Shower", mult: 1.6, sub:"+60% to all production for ~25s.", dur: 25000 },
      { name:"Time Ripple", mult: 1.35, sub:"+35% to all production for ~22s.", dur: 22000 },
      { name:"Lucky Alignment", mult: 2.1, sub:"2.1√ó to all production for ~20s.", dur: 20000 },
    ];
    const e = pick(events);
    S.cosmicEvent = { name: e.name, mult: e.mult, until: now() + e.dur, sub: e.sub };

    $("eventBanner").style.display = "block";
    $("eventTxt").textContent = e.name;
    $("eventSub").textContent = e.sub;
    S.achUnlocked._eventSeen = true;

    toast("Cosmic Event!", e.name);
    addLog("gold", "Cosmic Event", `${e.name} started. (${e.sub})`);
    saveDebounced();
  }

  function updateEventBanner(){
    if (S.cosmicEvent && now() < S.cosmicEvent.until){
      $("eventBanner").style.display = "block";
      $("eventTxt").textContent = S.cosmicEvent.name;
      $("eventSub").textContent = S.cosmicEvent.sub || "";
    } else {
      S.cosmicEvent = null;
      $("eventBanner").style.display = "none";
    }
  }

  // ---------- Ship Arena (automated mini-game) ----------
  const ship = $("ship");
  const shipViewport = $("shipViewport");
  const shipProjectiles = $("shipProjectiles");
  const shipObstacles = $("shipObstacles");
  const shipCollectibles = $("shipCollectibles");

  const SHIP_PART_IDS = ["gloves","tapRhythm","lens","autopulse","efficiency","boostCool","union","compressor","blueprints","drone","mine","foundry","observatory","rift"];
  function updateShipVisual(){
    if (!ship) return;
    ship.querySelectorAll("[data-part]").forEach(el => {
      const id = el.getAttribute("data-part");
      const unlocked = hasTool(id) || (S.machinesOwned && (S.machinesOwned[id] || 0) > 0);
      el.classList.toggle("unlocked", !!unlocked);
    });
    const partsCount = SHIP_PART_IDS.filter(id => hasTool(id) || (S.machinesOwned && (S.machinesOwned[id] || 0) > 0)).length;
    const hudParts = $("shipHudParts");
    if (hudParts) hudParts.textContent = `Parts: ${partsCount}`;
  }

  let shipX = 50;           // % of viewport width
  let shipDir = 1;         // 1 = right, -1 = left
  let shipLastShot = 0;
  let shipHitUntil = 0;
  const projectiles = [];
  const obstacles = [];
  const collectibles = [];

  function shipSpeedMult(){
    const dust = S.dust || 0;
    return 1 + Math.min(3, Math.log10(dust + 1) * 0.8);
  }
  function shipFireRateMs(){
    let ms = 500;
    if (hasTool("compressor")) ms *= 0.7;
    if (hasTool("lens")) ms *= 0.9;
    const dust = S.dust || 0;
    ms /= (1 + Math.min(2, Math.log10(dust + 1) * 0.3));
    return Math.max(120, ms);
  }

  function shipTick(dt){
    if (!shipViewport || !ship) return;
    const vw = shipViewport.offsetWidth;
    const vh = shipViewport.offsetHeight;
    if (vw <= 0) return;

    const speed = shipSpeedMult() * 25 * dt;
    shipX += shipDir * speed;
    if (shipX >= 92) { shipX = 92; shipDir = -1; }
    if (shipX <= 8) { shipX = 8; shipDir = 1; }
    ship.style.left = shipX + "%";
    ship.style.marginLeft = "-24px";
    if (shipHitUntil > now()) ship.classList.add("shipHit");
    else ship.classList.remove("shipHit");

    const shipPx = (shipX / 100) * vw;
    const shipLeft = shipPx - 24;
    const shipRight = shipPx + 24;
    const shipTop = vh - 74;
    const shipBottom = vh - 42;

    // Spawn obstacles (asteroids / junk)
    const obstacleRate = 0.15 + Math.min(0.25, (S.totalDust || 0) / 50000) * dt;
    if (Math.random() < obstacleRate){
      const obs = document.createElement("div");
      const isJunk = Math.random() < 0.4;
      obs.className = "obstacle " + (isJunk ? "junk" : "asteroid");
      obs.dataset.x = vw + 30;
      obs.dataset.y = 30 + Math.random() * (vh - 100);
      obs.dataset.vx = -80 - Math.random() * 120;
      obs.dataset.hp = hasTool("lens") ? 0.6 : 1;
      obs.style.left = obs.dataset.x + "px";
      obs.style.top = obs.dataset.y + "px";
      shipObstacles.appendChild(obs);
      obstacles.push(obs);
    }

    // Spawn collectibles (stardust crystals)
    const collectRate = 0.03 + Math.min(0.04, (S.dust || 0) / 10000) * dt;
    if (Math.random() < collectRate){
      const col = document.createElement("div");
      col.className = "collectible";
      col.dataset.x = Math.random() < 0.5 ? -20 : vw + 20;
      col.dataset.y = 40 + Math.random() * (vh - 80);
      col.dataset.vx = col.dataset.x < 0 ? 60 : -60;
      col.style.left = col.dataset.x + "px";
      col.style.top = col.dataset.y + "px";
      shipCollectibles.appendChild(col);
      collectibles.push(col);
    }

    // Auto-shoot at nearest obstacle to the left of center
    const nearest = obstacles.filter(o => parseFloat(o.dataset.x) < vw * 0.85).sort((a, b) => parseFloat(a.dataset.x) - parseFloat(b.dataset.x))[0];
    if (nearest && now() - shipLastShot >= shipFireRateMs()){
      shipLastShot = now();
      const proj = document.createElement("div");
      proj.className = "proj" + (hasTool("lens") ? " gold" : hasTool("mine") ? " purple" : "");
      proj.dataset.x = shipRight;
      proj.dataset.y = shipTop + 20;
      proj.dataset.vx = 420;
      proj.dataset.targetId = nearest.dataset.id || (nearest.dataset.id = "o" + Math.random());
      nearest.dataset.id = proj.dataset.targetId;
      proj.style.left = proj.dataset.x + "px";
      proj.style.top = proj.dataset.y + "px";
      shipProjectiles.appendChild(proj);
      projectiles.push(proj);
    }

    // Move projectiles
    projectiles.forEach(p => {
      let x = parseFloat(p.dataset.x) + parseFloat(p.dataset.vx || 400) * dt;
      p.dataset.x = x;
      p.style.left = x + "px";
      if (x > vw + 20) p.remove();
    });

    // Move obstacles & collision with projectiles
    obstacles.forEach(o => {
      let x = parseFloat(o.dataset.x) + parseFloat(o.dataset.vx || -100) * dt;
      o.dataset.x = x;
      o.style.left = x + "px";
      o.style.top = o.dataset.y + "px";

      projectiles.forEach(p => {
        if (!p.parentNode) return;
        const px = parseFloat(p.dataset.x);
        const py = parseFloat(p.dataset.y);
        const ox = parseFloat(o.dataset.x);
        const oy = parseFloat(o.dataset.y);
        const rad = o.classList.contains("junk") ? 10 : 14;
        if (Math.abs(px - ox) < 20 && Math.abs(py - oy) < rad + 6){
          let hp = parseFloat(o.dataset.hp || 1) - (hasTool("lens") ? 0.5 : 0.35);
          if (hp <= 0) o.remove();
          else o.dataset.hp = hp;
          p.remove();
        }
      });

      if (x < -40) o.remove();

      // Ship hit?
      const ox2 = x + (o.classList.contains("junk") ? 8 : 12);
      const oy2 = parseFloat(o.dataset.y) + (o.classList.contains("junk") ? 8 : 12);
      if (ox2 > shipLeft && x < shipRight && oy2 > shipTop && parseFloat(o.dataset.y) < shipBottom && now() > shipHitUntil){
        shipHitUntil = now() + 800;
        const lost = Math.max(1, Math.floor((S.dust || 0) * 0.002));
        S.dust = Math.max(0, (S.dust || 0) - lost);
        o.remove();
      }
    });

    // Move collectibles & collect
    collectibles.forEach(c => {
      let x = parseFloat(c.dataset.x) + parseFloat(c.dataset.vx || 0) * dt;
      c.dataset.x = x;
      c.style.left = x + "px";
      const cx = x + 6;
      const cy = parseFloat(c.dataset.y) + 6;
      if (cx > shipLeft && cx < shipRight && cy > shipTop && cy < shipBottom){
        S.dust = (S.dust || 0) + 1;
        S.totalDust = (S.totalDust || 0) + 1;
        c.remove();
      }
      if (x < -30 || x > vw + 30) c.remove();
    });

    // Prune removed nodes from arrays
    projectiles.splice(0, projectiles.length, ...projectiles.filter(p => p.parentNode));
    obstacles.splice(0, obstacles.length, ...obstacles.filter(o => o.parentNode));
    collectibles.splice(0, collectibles.length, ...collectibles.filter(c => c.parentNode));

    // HUD
    const hudSpeed = $("shipHudSpeed");
    if (hudSpeed) hudSpeed.textContent = "Speed: " + shipSpeedMult().toFixed(1) + "√ó";
  }

  // ---------- Save / Load ----------
  const SAVE_KEY = "starforger_clicker_save_v3";

  function save(){
    const payload = { S, t: now(), version: 3 };
    localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
  }

  let saveTimer = null;
  function saveDebounced(){
    if (saveTimer) return;
    saveTimer = setTimeout(() => {
      saveTimer = null;
      save();
    }, 300);
  }

  function load(){
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw){
      toast("No save found", "Play a bit, then hit Save.");
      return;
    }
    const payload = JSON.parse(raw);
    if (!payload || !payload.S){
      toast("Save corrupted", "Starting fresh.");
      S = structuredClone(BASE);
      return;
    }
    S = payload.S;

    // patch missing fields
    for (const k of Object.keys(BASE)){
      if (typeof S[k] === "undefined") S[k] = structuredClone(BASE)[k];
    }
    if (!S.toolsOwned) S.toolsOwned = {};
    if (!S.machinesOwned) S.machinesOwned = {};
    if (!S.achUnlocked) S.achUnlocked = {};
    if (!S.achBonusMult) S.achBonusMult = 1.0;

    // offline gains (passive only)
    const elapsed = Math.max(0, Math.floor((now() - (payload.t||now()))/1000));
    if (elapsed > 3){
      const gain = baseMachineDps() * currentMult() * elapsed;
      if (gain > 0){
        S.dust += gain;
        S.totalDust += gain;
        addLog("good", "Offline", `While you were gone (${elapsed}s), +${fmt(gain)} Stardust.`);
        toast("Offline gains", `+${fmt(gain)} Stardust`);
      }
    }

    updateEventBanner();
    checkAchievements();
    updateShipVisual();
    toast("Loaded", "Welcome back.");
  }

  function hardReset(){
    if (!confirm("Reset the entire game? This erases your save.")) return;
    localStorage.removeItem(SAVE_KEY);
    S = structuredClone(BASE);
    logEntries.length = 0;
    $("eventBanner").style.display = "none";
    toast("Reset", "All progress cleared.");
  }

  $("saveBtn").addEventListener("click", () => { save(); toast("Saved", "Stored in your browser."); addLog("good","Save","Game saved locally."); });
  $("loadBtn").addEventListener("click", load);
  $("resetBtn").addEventListener("click", hardReset);

  // ---------- Prestige ----------
  function shardsFromReboot(){
    const val = Math.floor(Math.pow(S.totalDust / 5000, 0.55));
    return Math.max(0, val);
  }
  function reboot(){
    const gain = shardsFromReboot();
    if (gain <= 0){
      toast("Too soon", "Forge more Stardust before rebooting.");
      return;
    }
    if (!confirm(`Reboot resets this run and grants +${gain} shards permanently. Continue?`)) return;

    const keep = S.shards + gain;
    addLog("purple", "Reboot", `Reality rebooted. +${gain} shards.`);
    toast("Rebooted", `+${gain} shards gained.`);

    S = structuredClone(BASE);
    S.shards = keep;
    S.dust = 10 + S.shards * 2;
    S.totalDust = S.dust;

    $("eventBanner").style.display = "none";
    save();
  }
  $("rebootBtn").addEventListener("click", reboot);

  // ---------- Rendering ----------
  function renderTop(){
    const mult = currentMult();
    const dps = baseMachineDps() * mult;
    const dpc = clickValue();

    ui.dustTxt.textContent = fmt(S.dust);
    ui.bigDust.textContent = `${fmt(S.dust)} Stardust`;
    ui.dpsTxt.textContent = fmt(dps);
    ui.dpcTxt.textContent = fmt(dpc);
    ui.rateTxt.textContent = `${fmt(dps)} per second ‚Ä¢ ${fmt(dpc)} per click`;

    ui.overTxt.textContent = `${Math.floor(S.overcharge)}%`;
    ui.overFill.style.width = `${S.overcharge}%`;

    ui.shardsTxt.textContent = S.shards;
    ui.achCountTxt.textContent = Object.keys(S.achUnlocked).filter(k => !k.startsWith("_")).length;

    const btn = $("boostBtn");
    if (now() < S.starboostUntil){
      const left = Math.ceil((S.starboostUntil - now())/1000);
      ui.boostTxt.textContent = `${left}s active`;
      btn.disabled = true;
    } else if (now() < S.starboostReadyAt){
      const left = Math.ceil((S.starboostReadyAt - now())/1000);
      ui.boostTxt.textContent = `${left}s cooldown`;
      btn.disabled = true;
    } else {
      ui.boostTxt.textContent = "ready";
      btn.disabled = false;
    }
  }

  // ---------- Main Loop ----------
  let last = now();
  function tick(){
    const t = now();
    const dt = Math.min(0.25, (t - last) / 1000);
    last = t;

    // passive
    const gain = baseMachineDps() * currentMult() * dt;
    if (gain > 0){
      S.dust += gain;
      S.totalDust += gain;
    }

    // combo decay
    if (t - S.lastClickAt > 1300) S.clickCombo = 0;

    // cosmic event check
    cosmicTimer += dt;
    if (cosmicTimer >= 20){
      cosmicTimer = 0;
      maybeCosmicEvent();
    }
    if (S.cosmicEvent && t >= S.cosmicEvent.until){
      updateEventBanner();
    }

    checkAchievements();

    // render
    renderTop();
    updateShopState();
    if (activeTab === "achievements") renderAchievements();
    shipTick(dt);

    requestAnimationFrame(tick);
  }

  // ---------- Tabs + clear log ----------
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", () => setTab(btn.dataset.tab));
  });
  $("clearLogBtn").addEventListener("click", () => {
    logEntries.length = 0;
    addLog("good","Log","Cleared.");
  });

  // ---------- Init ----------
  buildShopOnce();
  setTab("machines"); // ‚úÖ machines first
  addLog("good", "Welcome", "Click the orb to forge Stardust. Buy Machines for DPS, then Tools for buffs.");
  updateEventBanner();
  updateShipVisual();
  renderTop();
  updateShopState();
  requestAnimationFrame(tick);

  if (localStorage.getItem(SAVE_KEY)) {
    toast("Tip", "You have a save already. Hit Load if you want it.");
  }
})();
</script>
</body>
</html>


